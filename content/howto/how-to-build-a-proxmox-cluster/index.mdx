---
title: How to build a Proxmox cluster
date: 2021-09-30
tags: ['Debian', 'Hypervisor', 'Linux', 'Proxmox', 'Server', 'VM']
excerpt: "This is the first post in a line of (planned) Proxmox how-to posts. In this first post I'll configure a server and install Proxmox and do some basic configuration."
cover: 'cover.png'
author: 'Joep van de Laarschot'
published: true
---

## Introduction

For years I wanted to build my own proper server setup, but all kinds of "rational" reasons prevented me from doing so. Having your own server is too expensive, too wasteful with electricity, too much work, too much time, too much risk. Well, I still agree that all of them are true, but fuck it, I wanted my own servers.

After years of struggling with a -more than decent- custom build home server, I decided to buy some proper equipment. My idea for what I wanted exactly was still really vague. And because I still consider this a semi-hobby project ([jodiBooks](https://jodibooks.com) is my main project), I looked for a cheap used server. After some browsing through classifieds on the Dutch site [Tweakers](https://tweakers.net/servers/aanbod/), I found two ads for two servers from the same seller and decided to buy them both and see what would happen.

That was 3 months ago and, man, I learned a lot in this short period. This has been a hard and frustrating, but ultimately satifying ride. And I am glad I finally have some time to write everything down (ðŸ¤ž*please don't crash now and have me start from scratch*ðŸ¤ž).

This is the first post in a line of (planned) [Proxmox](https://www.proxmox.com) how-to posts. In these posts I want to compile everything I found on multiple websites, blogs and forums in hopes that this guide will prevent you, at least some, frustrations. In this first post I'll configure a server and install [Proxmox](https://www.proxmox.com) and do some basic configuration. That should be a good starting point for running the first VM's.

### What do we want to do

This is my personal list of things this server (or servers) should do:

* Store lots of data
* Run virtual machines
* Do network routing
* Automate lots of stuff for jodiBooks
* Let me fiddle with [crypto/web3](https://www.freecodecamp.org/news/what-is-web3/)

### Hardware selection

Depending on your situation, you can either start with a plan (see previous paragraph) and look for hardware that fits or you already have hardware and than start planning. For this guide it doesn't really matter what hardware you have around. Although I have a proper server now, I will use my old trusty home server for this guide.

It has a Supermicro X9SCM mainboard, Xeon E3-1230 v2 CPU and 32 GB of RAM. I also installed an [IBM Serveraid M1115](https://www.amazon.com/IBM-Serveraid-Controller-System-81Y4448/dp/B007V8S0D8) HBA card which has a LSI 9211-8i chipset. This is a must have if you want to have lots of hard disks for storage. Another recommendation for a home server is the chassis for which I bought the [Fractal design node 804](https://www.amazon.com/Fractal-Design-Node-Case-Computer/dp/B00JBBH93K). It has lots of space, is very quiet and its fan filters catch a lot of dust.

### Hypervisor selection

The most difficult decision is the choice for a hypervisor. I new ESXi from my first dabbles into home servers, but I ditched it in favor of using Ubuntu with VirtualBox. This is not the way you want to run virtual machines in a production environment, so I tried multiple hypervisors and ultimately settled on using [Proxmox](https://www.proxmox.com) for these reasons:

* Price: free
    * Proxmox is free and open-source as opposed to [ESXi](https://www.vmware.com/products/esxi-and-esx.html) (VMWare)
* Technology: [KVM](https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine) / [QEMU](https://en.wikipedia.org/wiki/QEMU)
    * Proxmox is based on KVM which is build into the Linux kernel
    * [Big players (AWS) are migrating](https://www.freecodecamp.org/news/aws-just-announced-a-move-from-xen-towards-kvm-so-what-is-kvm/) from [XEN](https://xenproject.org/), the "other" open-source option, to KVM
    * Also, on XEN I couldn't get a VM with [Golem]() to work. Which was to be expected as they wrote: "[We do not support XEN hypervisor](https://handbook.golem.network/troubleshooting/provider-troubleshooting)".
* Ease of use: GUI
    * Proxmox was the only KVM based option that I actually got to a working state.
    * KVM with the [Cockpit](https://cockpit-project.org/) GUI is too limited. Most things still needed to be done through the CLI. I now see that "[The Cockpit Web Console is extendable](https://cockpit-project.org/applications.html)".
    * [OpenNebula](https://opennebula.io/)'s implementation is too complicated. Everything needs to be configured manually.
    * [oVirt](https://ovirt.org/) needs a dedicated storage machine.
    * ESXi so far has the best GUI in my opinion, but the free version is too limited.

## Hardware preparation



### Flash HBA

### Disks

## Proxmox

### Installation

The machine will run Proxmox as their base operating system. Too be precise, Proxmox supplies an ISO file that installs Debian with Proxmox preinstalled and configured. This machine is known in Proxmox as a **node**. 

Follow the instructions of the installer. Follow this link to get to an "official" tutorial: <https://forum.proxmox.com/threads/proxmox-beginner-tutorial-how-to-set-up-your-first-virtual-machine-on-a-secondary-hard-disk.59559/>

<Alert type='warning'>
    Proxmox needs to boot from BIOS on these nodes. They can probably boot from UEFI too, but as the ISO was booted through BIOS the OS is configured to boot from BIOS. So <strong>do not change boot option to UEFI!</strong>
</Alert>

### Configuration

#### Cluster

The nodes are linked together in a cluster `JPL-cluster`. This makes it possible to:

* Use a single login
    * Single username-password
    * Single private-public key
* Control the nodes and VM's from a single GUI
* Migrate VM's between nodes

<Alert type='warning'>
    Proxmox config is very delicate. Almost all settings can be configured through the GUI, but sometimes you might have to dig into config files with the CLI. <strong>ALWAYS make a backup before doing so!</strong> I learned the hard way that messing up only one file (especially related to the cluster) can mean a full reinstall of that cluster!
</Alert>