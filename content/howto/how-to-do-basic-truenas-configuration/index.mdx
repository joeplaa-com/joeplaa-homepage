---
title: How to do basic TrueNas configuration
date: 2021-10-06
tags: ['Server', 'TrueNas']
excerpt: "This guide shows how to some basic TrueNas configuration."
cover: 'cover.png'
author: 'Joep van de Laarschot'
published: true
---

## Introduction

What [started as a project](https://blog.joeplaa.com/building-a-proxmox-cluster/) to run "some crypto applications" grew into something much bigger, but also more useful. I learned a tremendous amount about virtual machines, lxc containers and Proxmox. And although I'm just scratching the surface and I don't actually understand it, I know how to do some things. I'll write them down here, partly for myself, but also for you in hopes it will save one of us a lot of time and frustration.

## Contents

* [Create a storage pool](#create-a-storage-pool)
* [Configure SMART checks and scrubs](#configure-smart-checks-and-scrubs)
* [Configure users](#configure-users)
* [Configure samba sharing](#configure-samba-sharing)
* [Configure NFS sharing](#configure-nfs-sharing)
* [Configure a iSCSI disk](#configure-a-iscsi-disk)
* [Configure reporting](#configure-reporting)

## Create a storage pool

You have TrueNas for storage, so the first thing you want to do is create a storage pool. This is a set off disks grouped together to store data. Obviously this is an oversimplification. Read [this article](https://www.servethehome.com/an-introduction-to-zfs-a-place-to-start/) for a more in depth introduction into how ZFS works.

1. Open the TrueNas WebGUI and go to "Storage".

    ![add a storage pool](add-a-storage-pool.png)

2. Click "Add" and in the new window click "Create Pool".

    ![create pool](create-pool.png)

3. Give the pool a name (`pool1`) and select the disks you planned to use for data storage. In this example I have 4 2TB disks that I combine in a single RAID-Z VDev. Keep in mind that this is [not recommended](https://www.digistor.com.au/the-latest/Whether-RAID-5-is-still-safe-in-2019/) (anymore) and you probably want to use (more disks) with RAID-Z2.

    ![pool manager](pool-manager.png)

4. Confirm that you want this pool to be created.

    ![pool manager confirm](pool-manager-confirm.png)

5. You now have a storage pool.

    ![storage pool](storage-pool.png)

## Configure S.M.A.R.T. checks and scrubs

Now that your storage pool is up, you have to keep track of the health of that pool and the underlying disks. This can be done by scheduling regular [S.M.A.R.T.](https://en.wikipedia.org/wiki/S.M.A.R.T.) tests to check the health of your disks and schedule "scrubs" to check the health of your pool (data) and correct errors. Read more about the specifics in [this thread](https://www.truenas.com/community/threads/scrub-and-smart-testing-schedules.20108/) on the TrueNas forums.

### S.M.A.R.T. checks

1. Go to "Tasks" -> "S.M.A.R.T. Tests" and click the "Add" button.

    ![SMART tests empty](smart-tests-empty.png)

2. Check "All Disks", choose Type "SHORT" and give it a description, for example: `Short SMART Test: Every 5th, 12th, 19th, and 26th of the month at 3:00 am`.

    ![SMART tests short description](smart-tests-short1.png)

3. Click on the schedule and choose "Custom". This will open a popup where you can enter a schedule. I followed the advice from the forums, see the description in previous step.

    ![SMART tests short schedule](smart-tests-short2.png)

4. Click "Submit" to save the schedule.

    ![SMART tests short submit](smart-tests-short3.png)

5. Click the "Add" button again.

    ![SMART tests short](smart-tests-short.png)

6. Check "All Disks", choose Type "LONG" and give it a description, for example: `Long SMART Test: Every 8th and 22nd at 3:00 am`.

    ![SMART tests long description](smart-tests-long1.png)

7. Click on the schedule and choose "Custom". This will open a popup where you can enter a schedule. I followed the advice from the forums, see the description in previous step.

    ![SMART tests long schedule](smart-tests-long2.png)

8. Click "Submit" to save the schedule.

    ![SMART tests long submit](smart-tests-long3.png)

9. You have now added the S.M.A.R.T. health checks and will be notified by TrueNas is something is wrong. This will be configured in [Configure reporting](#configure-reporting)

    ![SMART tests](smart-tests.png)

### Scrubs

1. Go to "Tasks" -> "Scrub Tasks". You will see TrueNas created a default task for the pool you created. Click on the "triple dots" icon and choose "Edit"

    ![Scrub tasks default](scrub-tasks-default.png)

2. Change the "Threshold days" to `10` and give the task a description, for example: `SCRUBS: 1st and 15th of the month at 3:00am. Threshold is set to 10 days.`.

    ![Scrub tasks description](scrub-tasks-step1.png)

3. Click on the schedule and choose "Custom". This will open a popup where you can enter a schedule. I followed the advice from the forums, see the description in previous step.

    ![Scrub tasks schedule](scrub-tasks-step2.png)

4. Click "Submit" to save the schedule.

    ![Scrub tasks submit](scrub-tasks-step3.png)

5. You have now configured (more) scrubs and will be notified by TrueNas is something is wrong. This will be configured in [Configure reporting](#configure-reporting)

    ![Scrub tasks](scrub-tasks.png)

## Configure users

If you want to enable samba (SMB) sharing, you have to create users (or allow anonymous sharing). For completeness and because it is safer, I will create a user that has access to the SMB shares from a Windows machine.

1. Go to "Accounts" -> "Users" and click the "Add" button

    ![Users empty](users-empty.png)

2. Add "Name", "Username" and "Password".

    ![User add name](user-add-name.png)

3. Scroll down and check "Microsoft Account".

    ![User Miscrosoft account](user-add-ms-account.png)

4. Click "Submit" to save the user.

    ![Users](users.png)

5. Repeat for all users you want to create.

6. Go to "Accounts" -> "Groups". TrueNas has created a group for each user you just created. This is not convenient when setting folder/file/share permissions. Add another group by clicking the "Add" button.

    ![Groups default](groups-default.png)

7. Add a "Name" for the group. I chose `samba-share-rw` as it descibes the intention of the group: read-write permissions for samba-shares.

    ![Group add name](group-add-name.png)

8. Click "Submit" to save the group. In the overview screen click on the `>` icon and then on the "Members" button.

    ![Groups details](groups-details.png)

9. Add the users you want to be members of the group and click save.

    ![Groups add members](group-add-members.png)

## Configure samba sharing

1. Go to "Services" and enable "SMB". Don't forget to check "Start Automatically".

    ![Enable SMB service](enable-smb-service.png)
    
2. Click on the pencil icon and change the "NetBIOS Name" and "Workgroup".

    ![Enable SMB settings](enable-smb-settings.png)

3. Go to "Storage" -> "Pools" and click on the triple dot icon behind your pool. Click "Add Dataset".

    ![Add dataset to pool](add-dataset-to-pool.png)

4. Give the dataset a name and use the comments to explain what data the dataset contains.

    ![Add dataset to pool settings](add-dataset-to-pool-settings.png)

5. Press "Submit". The dataset is now created.

    ![Dataset created](add-dataset-to-pool-created.png)

6. Go to "Sharing" -> "Windows Shares (SMB)" and click "Add".

    ![Samba shares empty](smb-shares-empty.png)

7. Choose the dataset (folder) you just created and add a description.

    ![Add samba share](add-smb-share.png)

8. After clicking submit TrueNas will ask if it should configure ACL. Choose to configure it.

    ![Add samba share ACL](add-smb-share-acl.png)

9. Click "Add ACL item". Choose `Group` and type the name of the group you created. I wanted read-write permissions so for "Permissions" I choose `Modify`.

    ![Add samba share ACL item](add-smb-share-acl-add-item.png)

10. Click save. The share is now visible in Windows. You might need to restart the TrueNas server/VM to get the right NetBIOS name to show.

    ![Samba share in Windows](smb-share-in-windows.png)

## Configure NFS sharing

If you want to share files with Linux machines, NFS might work better than SMB (check the sources at the bottom of this guide).

1. Go to "Services" and enable "NFS". Don't forget to check "Start Automatically".

    ![Enable NFS service](nfs-enable-service.png)

2. Click on the pencil icon and check "Enable NFSv4" and "NFSv3 ownership for NFSv4".

    ![Enable NFS settings](nfs-enable-service-settings.png)

3. Go to "Storage" -> "Pools" and click on the triple dot icon behind your pool. Click "Add Dataset".

    ![Add dataset to pool](add-dataset-to-pool-nfs.png)

4. Give the dataset a name and use the comments to explain what data the dataset contains.

    ![Add dataset to pool settings](add-dataset-to-pool-settings-nfs.png)

5. Press "Submit". The dataset is now created.

    ![Dataset created](add-dataset-to-pool-created-nfs.png)

6. Go to "Sharing" -> "Unix Shares (NFS)" and click "Add".

    ![NFS shares empty](nfs-shares-empty.png)

7. Choose the dataset (folder) you just created and add a description.

    ![Add NFS share](add-nfs-share.png)

8. Click "Advanced Options" and set permissions: Maproot User `root`, Maproot Group `wheel`. Because I'm making a Proxmox share I only allow the Proxmox host by IP address. Leave this blank if you don't want to restrict access.

    ![Add NFS share permissions](add-nfs-share-permissions.png)

9. Go to "Services" and restart "NFS" (disable -> enable).

10. Now you can add the share (example shows Proxmox).

    ![NFS share mounted in Proxmox](nfs-mounted-proxmox.png)

## Configure an iSCSI disk

This is something I needed to do very recently for a [Storj](https://storj.io) VM and I don't fully understand it yet. So for now I suggest to look here: [How to Create iSCSI Target on TrueNAS](https://manjaro.site/how-to-create-iscsi-target-on-truenas/).

1. I followed the first to the letter (ok, I changed the zvol and block share names to `iscsi-pve1`) to create an iSCSI target on TrueNas.
2. Then in Proxmox I added this target as iSCSI storage.
3. On top of that iSCSI storage link I created LVM storage.
4. Now I could create a virtual hard disk and link it to the Storj guest.

There is probably a better, more direct approach, but I haven't learned about that yet. I tried running an Ubuntu VM in TrueNas, but starting this VM would result in the TrueNas guest to freeze. This might be a nesting problem, not sure though.

## Configure reporting

If something is wrong with a TrueNas service or the disks, TrueNas can send you an email. This has to be configured obviously.

1. Go to "Accounts" -> "Users" and click the `>` icon behind the root user. Click "Edit".

    ![Add email address root user](add-email-root1.png)

2. Add your email address.

    ![Add email address root user](add-email-root2.png)

3. Go to "System" -> "Email" and add a working "From Email" address (for me the domain had to be verified in AWS SES). I'm running my own SMTP relay that I can send my system emails to. This relay will then use AWS SES to send them to my mailbox. If you want to use Gmail try [this](https://ubuntuhak.blogspot.com/2020/12/e-mail-notifications-in-freenas-using.html), but it seems [Google is disabling app passwords](https://www.reddit.com/r/freenas/comments/ih23yz/gmail_notifications_from_truenas_core_reprieve/) needed to authenticate.

    ![Set email address and server](email1.png)

4. Click "Send test mail". You should receive an email shortly.

    ![Test email](email2.png)

***

<Alert type='info'>
    <h3 class='mt-1'>Sources:</h3>

#### ZFS, RAID

* <https://www.servethehome.com/an-introduction-to-zfs-a-place-to-start/>
* <https://arstechnica.com/information-technology/2020/05/zfs-101-understanding-zfs-storage-and-performance/>
* <https://www.truenas.com/community/threads/slideshow-explaining-vdev-zpool-zil-and-l2arc-for-noobs.7775/>
* <https://www.digistor.com.au/the-latest/Whether-RAID-5-is-still-safe-in-2019/>

#### SMART checks and scrubs

* <https://www.truenas.com/community/threads/scrub-and-smart-testing-schedules.20108/>
* <https://yadafaber.com/scrub-and-smart-testing-schedules-for-freenas/>

#### SMB vs NFS

* <https://blog.ja-ke.tech/2019/08/27/nas-performance-sshfs-nfs-smb.html>
* <https://ferhatakgun.com/network-share-performance-differences-between-nfs-smb/>

#### iSCSI

* <https://manjaro.site/how-to-create-iscsi-target-on-truenas/>
* <https://manjaro.site/how-to-connect-to-iscsi-volume-from-ubuntu-20-04/>

</Alert>